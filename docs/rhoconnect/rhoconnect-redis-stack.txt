# Creating a RhoConnect Stack in Amazon Web Services

This tutorial will guide you through setting up a Redis stack and a RhoConnect application stack in the Amazon Web Service (AWS) cloud.

The RhoConnect application stack is scalable; it uses load balancing to automatically distribute and balance the incoming application traffic among all the instances you are running. You will set the maximum number of instances that the load balancer can create for your RhoConnect application.

## Logging onto the Amazon Web Service

Go to the [Amazon Web Service (AWS) Console](http://aws.amazon.com/console/) and click on the Sign in to the AWS Console button. You can sign into an existing AWS account, or create a new one.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/AWS-login-button.png" alt="AWS login button" />

Or you can open the URL for your account directly if you have the account number: 

	:::term
	https://<your_account_number>.signin.aws.amazon.com/console

The login screen for your AWS account appears. Enter your User Name and Password for your AWS account, then click the Sign in button.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/aws-sign-in-account-number.png" alt="AWS login page" />

The AWS Management Console appears. 

## Creating a Custom RhoConnect Image

In the AWS Management Console, change the Region to US West (N. California).

**NOTE:** The stacks created in this document only work in the North California region.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/cloudformation-tab-ncalif-crop.png" alt="Cloud Formation page N California region" />

We provide a public preconfigured image that contains a blank RhoConnect app:

 * ami-65e4bb20 (Us West N. California)

### Launching an Instance

To create your own RhoConnect Image, launch an EC2 Image. Click the EC2 tab, then click the Launch Instance button.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/ec2-launch-instance.png" alt="Launch Instance button" />

Click the Launch Classic Wizard radio button. Click Continue.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-new-instance-launch-classic-wizard.png" alt="create new instance classic wizard" />

### Requesting the Instance

In the Request Instance: Choose AMI wizard, click the Community AMIs tab. Then paste in the AMI `ami-65e4bb20`. The preconfigured RhoConnect AMI appears. Click Select.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/request-instances-wizard-community-AMIs.png" alt="request instances - choose AMI" />

In Request Instances Wizard - Instance Details, select the Instance Type (such as Large).

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/request-instances-instance-details.png" alt="request instances - instance details" />

In the Request Instances Wizard, Instance Details, Advanced Instance Options, change nothing. Click Continue.

In Request Instances Wizard - Instance Details, for adding tags, enter a name for your custom RhoConnect EC2 instance. Click Continue.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/request-instances-instance-details-add-tags.png" alt="request instances - add tags" />

In Request Instances Wizard - Create Key Pair, select your existing key pair or create a new keypair.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/request-instances-key-pair.png" alt="request instances - key pair" />

### Requesting the Instance - Configuring the Firewall

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/request-instances-configure-firewall.png" alt="request instances - configure firewall" />

In the Request Instances Wizard - Configure Firewall, click the Create New Security Group.

**NOTE:** You can use a preexisting security group if it has the open ports 22, 80, and 6379.

CLick the Add Rule button to add each port.

 * Add port 22 for SSH.
 * Add port 80 for HTTP.
 * Add port 6379 for redis.

Enter a firewall name and a group description.

Click Continue.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/request-instances-review.png" alt="request instances - review" />

You can see Request Instances Wizard - Review. Click Launch. 

In the window that shows it is launching, click Close.

### Customizing the Instance

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/instances-instances.png" alt="instances - instances" />

In the EC2 tab, Click on Instances / Instances.

Under Viewing, select Running Instances. Right-click on your RhoConnect instance. Then scroll down to see Private DNS. 

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/running-instances-public-dns.png" alt="running instances - public dns" />

You will need:

 * your keypair
 * the public DNS name of the Instance, which you will see as the public DNS name in the running instance, such as `ec2-184-72-16-39.us-west-1.compute.amazonaws.com`.
 * the username: `ec2-user`

From the command line, run an ssh command to login to the running instance, using the keypair, DNS name, and user name. For example:

	:::term
	$ ssh -i ~/.ssh/devkey.pem ec2-user@ec2-50-18-229-26.us-west-1.compute.amazonaws.com

Replace the blank 'rhoapp' application in the /opt/nginx/html folder with your app, and set its owner as 'nginx' user.

	:::term
	$ cd /opt/nginx/html
	# ... copy your application here under name 'rhoapp'
	$ sudo chown -R nginx:nginx rhoapp

You can test the application.

	:::term
	$ sudo /etc/init.d/redis start
	$ sudo /etc/init.d/nginx start

If everything is configured properly, then you can login to the RhoConnect web console in your browser by using the instance public DNS name as the URL in your browser. When you are done, you can stop the application.

	:::term
	$ sudo /etc/init.d/nginx stop
	$ sudo /etc/init.d/redis stop

## Create the Image

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/running-instances-public-dns.png" alt="Create Image popup" />

In the EC2 tab, right-click the RhoConnect instance and select Create Image from the popup menu.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-image.png" alt="Create Image" />

In the Create Image window, enter the image name and description for your custom image. Then click Create This Image.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-image-request.png" alt="Create Image request" />

In the Create Image window showing that the request is received, click on "View pending image: ami-NNNNNNN to go to your Amazon Machine Image.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/ami-image.png" alt="amazon machine image" />

Copy the AMI number; you will use it when you create the scaleable RhoConnect stack.

## Creating the Scalable RhoConnect Stack

Click the Cloud Formation tab.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/cloudformation-tab.png" alt="Cloud Formation page" />

Click the Create New Stack button.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/cloudformation-tab-new-stack-button.png" alt="Cloud Formation page new stack button" />

The Create Stack: Select Template window appears.

### Create Stack - Select Template

In the Create Stack: Select Template window, you must select the template file for your redis stack. This is the template to run the AMI image with the Redis server. 

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-stack-select-template.png" alt="Create Stack Select Template window" />

First, enter the name that you want for your stack into the Stack Name field.

Now get the template by either providing the URL for the template file, or by uploading the template file.

#### Providing the URL for the Template File

Click the Provide a Template URL radio button.

Copy the following URL and paste it into the text field below the Provide a Template URL radio button.

`https://s3-us-west-1.amazonaws.com/rhoconnect-ca-deploy/rhoconnect_template.txt`

Click Continue. The Create Stack: Specify Parameters window appears.

#### Uploading the Template File

Click the Upload a Template File radio button.

In another browser window, go to [https://s3-us-west-1.amazonaws.com/rhoconnect-ca-deploy/rhoconnect_template.txt](https://s3-us-west-1.amazonaws.com/rhoconnect-ca-deploy/rhoconnect_template.txt).

Save that text file to your computer.

Click the Choose File button, and navigate to and select your template file.

Click Continue. The Create Stack: Specify Parameters window appears.

### Create Stack - Specify Parameters

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-stack-specify-parameters.png" alt="Create Stack Specify Parameters window" />

In the Create Stack: Specify Parameters window:

 * Enter the AMI image number that you saved earlier.
 * Enter the maximum number of RhoConnect application servers that you want to run in your stack. Default = 2.
 * Enter the name for your existing EC2 KeyPair to enable SSH access to the stack instances.

Click Continue. The Create Stack: Review window appears.

### Create Stack - Review

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-stack-review.png" alt="Create Stack Review window" />

Click Continue. The window showing that the stack is being created appears.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/create-stack-being-created.png" alt="Create Stack being created window" />

Click Close.

## Checking the Status

In the AWS Management Console, Cloud Formation tab, click the checkbox for your stack. To see the progress of the creation of your stack, click the Refresh button; the status should become CREATE_COMPLETE soon.

To see the progress of the components in your stack, you can click the Events tab. You can click the refresh button to see the progress.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/aws-management-create-complete.png" alt="AWS Management CREATE_COMPLETE window" />

## Using the RhoConnect Application URL

In the AWS Management Console, Cloud Formation tab, click the Outputs tab. You will see a list of the Stack Outputs. 

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/aws-management-outputs.png" alt="AWS Management Stack Outputs window" />

At the top of the output list is the URL of the RhoConnect application. You can click on it to see the RhoConnect Console for the running RhoConnect server.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/rhoconnect-console.png" alt="RhoConnect Console" />

To use this scaleable RhoConnect server in your Rhodes application, copy the URL for the RhoConnect application. The rhoconfig.txt file on your Rhodes application has a syncserver variable; set that to this URL. For example:

	:::term
	syncserver = http://rhoconnec-RhoLoadB-OX64XR1IKNT2-1364705573.us-west-1.elb.amazonaws.com

## Deleting the Stack

You are charged for the stack that you have created, by the hour. When you no longer want to use the stack, you can delete it by right-clicking on the stack name in the AWS Management Console, Cloud Formation tab, and clicking Delete Stack in the pop-up menu.

<img src="http://rhodocs.s3.amazonaws.com/rhoconnect-redis-aws/delete-stack.png" alt="Delete Stack" />
















